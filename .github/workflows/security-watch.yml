name: Security-sensitive file monitor

# Triggers when security-critical namespace handling code changes
on:
  push:
    branches: [main]
    paths:
      - 'src/libsystemd/sd-bus/bus-container.c'
      - 'src/machine/machine.c'
      - 'src/machine/machine-dbus.c'
      - 'src/basic/namespace-util.c'

jobs:
  alert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E 'bus-container\.c|machine\.c|machine-dbus\.c|namespace-util\.c' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build alert message
        id: message
        run: |
          cat << 'EOF' > /tmp/alert.md
          ## ⚠️ Security-Sensitive File Changed in systemd

          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.event.head_commit.author.name }}
          **Message:** ${{ github.event.head_commit.message }}
          **URL:** ${{ github.event.head_commit.url }}

          ### Changed files:
          ```
          ${{ steps.changed.outputs.files }}
          ```

          ### Why this matters:
          These files contain namespace handling code related to a potential TOCTOU race
          condition in `machined`. The current design is safe because `namespace_open()`
          opens FDs at execution time, but changes to these patterns could introduce
          vulnerabilities:

          - **bus-container.c**: `namespace_open()` call site - do not cache FDs
          - **machine.c**: `machine_bus_new()` - do not reuse connections
          - **machine-dbus.c**: Authorization checks - do not reorder
          - **namespace-util.c**: Core namespace FD handling

          Review for: FD caching, connection pooling, authorization reordering.
          EOF

      - name: Create security review issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Security Watch] ${context.payload.head_commit.message.split('\n')[0].substring(0, 60)}`,
              body: `## Security-Sensitive File Changed

            A commit in upstream systemd touched namespace handling code that is security-critical.

            | Field | Value |
            |-------|-------|
            | **Commit** | \`${context.sha.substring(0, 12)}\` |
            | **Author** | ${context.payload.head_commit.author.name} |
            | **Date** | ${context.payload.head_commit.timestamp} |
            | **URL** | ${context.payload.head_commit.url} |

            ### Commit message
            \`\`\`
            ${context.payload.head_commit.message}
            \`\`\`

            ### Changed files
            \`\`\`
            ${{ steps.changed.outputs.files }}
            \`\`\`

            ### Why this matters
            These files contain namespace handling code related to a TOCTOU race window in machined.
            The current design is safe because \`namespace_open()\` opens FDs at execution time,
            but changes could break this implicit protection.

            ### Review checklist
            - [ ] No namespace FD caching introduced
            - [ ] No connection pooling/reuse added
            - [ ] Authorization checks still happen before namespace FD opening
            - [ ] \`namespace_open()\` still called at execution time, not check time
            - [ ] No machine name-based re-lookup after authorization`,
              labels: ['security-watch'],
              assignees: ['skypher']
            });
