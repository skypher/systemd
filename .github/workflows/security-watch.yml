name: Security-sensitive file monitor

# Triggers when security-critical namespace handling code changes
on:
  push:
    branches: [main]
    paths:
      - 'src/libsystemd/sd-bus/bus-container.c'
      - 'src/machine/machine.c'
      - 'src/machine/machine-dbus.c'
      - 'src/basic/namespace-util.c'
  workflow_dispatch:  # Allow manual testing

jobs:
  alert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E 'bus-container\.c|machine\.c|machine-dbus\.c|namespace-util\.c' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build alert message
        id: message
        run: |
          cat << 'EOF' > /tmp/alert.md
          ## ⚠️ Security-Sensitive File Changed in systemd

          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.event.head_commit.author.name }}
          **Message:** ${{ github.event.head_commit.message }}
          **URL:** ${{ github.event.head_commit.url }}

          ### Changed files:
          ```
          ${{ steps.changed.outputs.files }}
          ```

          ### Why this matters:
          These files contain namespace handling code related to a potential TOCTOU race
          condition in `machined`. The current design is safe because `namespace_open()`
          opens FDs at execution time, but changes to these patterns could introduce
          vulnerabilities:

          - **bus-container.c**: `namespace_open()` call site - do not cache FDs
          - **machine.c**: `machine_bus_new()` - do not reuse connections
          - **machine-dbus.c**: Authorization checks - do not reorder
          - **namespace-util.c**: Core namespace FD handling

          Review for: FD caching, connection pooling, authorization reordering.
          EOF

      - name: Get commit info
        id: commit
        run: |
          # For manual dispatch, get latest commit info
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --format='%an')" >> $GITHUB_OUTPUT
          echo "date=$(git log -1 --format='%ci')" >> $GITHUB_OUTPUT
          echo "url=https://github.com/${{ github.repository }}/commit/$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          # Handle multiline message
          MSG=$(git log -1 --format='%B')
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          TITLE=$(git log -1 --format='%s' | cut -c1-60)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create security review issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Security Watch] ${{ steps.commit.outputs.title }}`,
              body: `## Security-Sensitive File Changed

            A commit in upstream systemd touched namespace handling code that is security-critical.

            | Field | Value |
            |-------|-------|
            | **Commit** | \`${{ steps.commit.outputs.short_sha }}\` |
            | **Author** | ${{ steps.commit.outputs.author }} |
            | **Date** | ${{ steps.commit.outputs.date }} |
            | **URL** | ${{ steps.commit.outputs.url }} |

            ### Commit message
            \`\`\`
            ${{ steps.commit.outputs.message }}
            \`\`\`

            ### Changed files
            \`\`\`
            ${{ steps.changed.outputs.files }}
            \`\`\`

            ### Background

            In Dec 2024 you audited systemd and found a TOCTOU race in machined's \`OpenShell\` D-Bus method:

            1. **The race window**: \`bus_machine_method_open_shell()\` checks if the caller can access the container's namespaces (line ~377 in machine-dbus.c), then later \`machine_bus_new()\` connects to the container using \`m->leader.pid\`.

            2. **The attack**: An attacker registers a container, calls OpenShell, then kills the container leader between the check and the connection. If the PID gets reused by a privileged process, the attacker could get a shell in that process's namespaces.

            3. **Why it's currently safe**: \`bus_container_connect_socket()\` in bus-container.c calls \`namespace_open(b->nspid, ...)\` which opens namespace FDs **fresh at execution time**. If the PID was reused, the FDs point to the new process's namespaces (not the attacker's target). The attacker can't control which process reuses the PID.

            4. **What would break it**: Caching namespace FDs at check time, connection pooling, or any pattern that separates "which namespaces" from "when we enter them".

            ### Review checklist
            - [ ] No namespace FD caching introduced
            - [ ] No connection pooling/reuse added
            - [ ] Authorization checks still happen before namespace FD opening
            - [ ] \`namespace_open()\` still called at execution time, not check time
            - [ ] No machine name-based re-lookup after authorization`,
              labels: ['security-watch'],
              assignees: ['skypher']
            });
