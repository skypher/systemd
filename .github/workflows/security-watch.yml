name: Security-sensitive file monitor

# Triggers when security-critical files change, then filters to specific code patterns
on:
  push:
    branches: [main]
    paths:
      - 'src/libsystemd/sd-bus/bus-container.c'
      - 'src/machine/machine.c'
      - 'src/machine/machine-dbus.c'
      - 'src/basic/namespace-util.c'
      - 'src/shared/bus-polkit.c'
      - 'src/nspawn/nspawn-seccomp.c'
  workflow_dispatch:  # Allow manual testing

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      dominated: ${{ steps.analyze.outputs.dominated }}
      details: ${{ steps.analyze.outputs.details }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Analyze changes for security impact
        id: analyze
        run: |
          # Get the diff for changed files
          DOMINATED="false"
          DETAILS=""

          # Define neuralgic patterns - these are the critical code points
          # Format: "filename:pattern:description"
          WATCHPOINTS=(
            # TOCTOU race - namespace FD handling
            "bus-container.c:namespace_open:namespace FD opening - critical for TOCTOU safety"
            "bus-container.c:namespace_fork:namespace entry point"
            "bus-container.c:b->nspid:PID used for namespace lookup"

            # TOCTOU race - machine connection
            "machine.c:machine_bus_new:container bus connection creation"
            "machine.c:x-machine-unix:container bus address format"
            "machine.c:m->leader:leader PID reference"

            # TOCTOU race - authorization check
            "machine-dbus.c:pidref_in_same_namespace:namespace authorization check"
            "machine-dbus.c:bus_machine_method_open_shell:shell access method"
            "machine-dbus.c:bus_verify_polkit:privilege check in machine methods"

            # Namespace utilities
            "namespace-util.c:namespace_open:core namespace FD opening"
            "namespace-util.c:namespace_fork:core namespace entry"
            "namespace-util.c:setns:direct namespace switch"

            # Polkit authorization
            "bus-polkit.c:bus_verify_polkit_async:main authorization function"
            "bus-polkit.c:async_polkit_query:authorization query handling"
            "bus-polkit.c:process_reply:authorization response processing"

            # Seccomp sandbox
            "nspawn-seccomp.c:allow_list:syscall allowlist definition"
            "nspawn-seccomp.c:SCMP_ACT_ALLOW:syscall permission grants"
            "nspawn-seccomp.c:add_syscall_filters:filter construction"
            "nspawn-seccomp.c:seccomp_add_syscall_filter_item:individual syscall rules"
            "nspawn-seccomp.c:CAP_:capability-gated syscalls"
          )

          # Check each watchpoint against the diff
          for wp in "${WATCHPOINTS[@]}"; do
            FILE=$(echo "$wp" | cut -d: -f1)
            PATTERN=$(echo "$wp" | cut -d: -f2)
            DESC=$(echo "$wp" | cut -d: -f3-)

            # Check if this file was changed and contains the pattern in diff
            if git diff HEAD~1 HEAD --unified=0 -- "*/$FILE" 2>/dev/null | grep -qE "^[+-].*$PATTERN"; then
              DOMINATED="true"
              DETAILS="${DETAILS}\n- **${FILE}**: \`${PATTERN}\` - ${DESC}"
            fi
          done

          echo "dominated=$DOMINATED" >> $GITHUB_OUTPUT

          # Handle multiline output
          echo "details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$DOMINATED" = "true" ]; then
            echo "::warning::Security-critical code patterns modified!"
          else
            echo "::notice::Changed files are watched but no critical patterns were modified"
          fi

  alert:
    needs: check
    if: needs.check.outputs.dominated == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E 'bus-container\.c|machine\.c|machine-dbus\.c|namespace-util\.c|bus-polkit\.c|nspawn-seccomp\.c' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get commit info
        id: commit
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --format='%an')" >> $GITHUB_OUTPUT
          echo "date=$(git log -1 --format='%ci')" >> $GITHUB_OUTPUT
          echo "url=https://github.com/${{ github.repository }}/commit/$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          MSG=$(git log -1 --format='%B')
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          TITLE=$(git log -1 --format='%s' | cut -c1-60)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Get diff excerpt
        id: diff
        run: |
          # Get relevant parts of the diff (limited to 100 lines)
          DIFF=$(git diff HEAD~1 HEAD --unified=3 -- \
            '*/bus-container.c' '*/machine.c' '*/machine-dbus.c' \
            '*/namespace-util.c' '*/bus-polkit.c' '*/nspawn-seccomp.c' \
            | head -100)
          echo "excerpt<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create security review issue
        uses: actions/github-script@v7
        with:
          script: |
            const details = `${{ needs.check.outputs.details }}`;
            const isManual = context.eventName === 'workflow_dispatch';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Security Watch] ${{ steps.commit.outputs.title }}`,
              body: `## Security-Critical Code Changed

            ${isManual ? 'âš ï¸ *Manual test run*' : 'ðŸš¨ **Neuralgic code patterns were modified**'}

            | Field | Value |
            |-------|-------|
            | **Commit** | \`${{ steps.commit.outputs.short_sha }}\` |
            | **Author** | ${{ steps.commit.outputs.author }} |
            | **Date** | ${{ steps.commit.outputs.date }} |
            | **URL** | ${{ steps.commit.outputs.url }} |

            ### Commit message
            \`\`\`
            ${{ steps.commit.outputs.message }}
            \`\`\`

            ### Critical patterns modified
            ${details || '(manual trigger - no pattern analysis)'}

            ### Changed files
            \`\`\`
            ${{ steps.changed.outputs.files }}
            \`\`\`

            ### Diff excerpt
            \`\`\`diff
            ${{ steps.diff.outputs.excerpt }}
            \`\`\`

            ---

            ### Background

            In Dec 2024 you audited systemd and identified these security-sensitive areas:

            **TOCTOU race in machined**
            - \`bus_machine_method_open_shell()\` checks namespace access, then \`machine_bus_new()\` connects using \`m->leader.pid\`
            - Safe because \`namespace_open()\` opens FDs fresh at execution time
            - **Would break if**: namespace FDs cached, connections pooled, or check/use separated

            **Polkit authorization (bus-polkit.c)**
            - All privilege checks flow through \`bus_verify_polkit_async()\`
            - **Watch for**: caching bugs, TOCTOU between check and action, bypass paths

            **Container seccomp (nspawn-seccomp.c)**
            - Defines syscall allowlist for containers
            - **Watch for**: dangerous syscalls added, capability gates removed

            ### Review checklist
            - [ ] No namespace FD caching introduced
            - [ ] No connection pooling/reuse added
            - [ ] \`namespace_open()\` still called at execution time
            - [ ] No polkit bypass paths added
            - [ ] No dangerous syscalls unblocked in seccomp`,
              labels: ['security-watch'],
              assignees: ['skypher']
            });
